# 自动/人工处理步骤操作指南

## 1. 系统概述

本指南详细说明如何使用主题模型系统的自动功能和手动干预步骤，帮助您高效地进行模型训练、评估和部署。系统支持全自动化处理流程，同时保留必要的人工干预点，以确保模型质量和灵活性。

## 2. 自动处理流程

### 2.1 自动部署流程

**功能说明**：自动完成数据预处理、模型训练、评估和部署的全流程。

**操作步骤**：

1. **准备环境**：
   - 确保Python 3.7+环境
   - 安装必要依赖：`pip install numpy pandas scikit-learn gensim jieba openpyxl`

2. **执行自动部署**：
   - 进入`training_new`目录
   - 运行部署脚本：
     ```bash
     python deploy_model.py
     ```

3. **查看部署结果**：
   - 脚本会自动输出部署过程和结果
   - 部署报告保存在`data/models/deployments/`目录

**自动流程执行内容**：
1. 数据准备和预处理
2. 训练新模型
3. 优化主题名称
4. 评估新模型性能
5. 与现有模型比较
6. 执行部署决策
7. 生成部署报告

### 2.2 自动性能监控

**功能说明**：定期监控模型性能，检测性能退化情况。

**操作步骤**：

1. **执行性能监控**：
   ```python
   from src.model_monitor import ModelMonitor
   from src.config import DATA_PATHS
   
   monitor = ModelMonitor()
   model_path = DATA_PATHS['models'] / 'lda_model.pkl'
   report = monitor.monitor_model_performance(model_path)
   
   # 查看警报
   alert = monitor.generate_alert(report)
   if alert:
       print(alert)
   ```

2. **设置定期监控**：
   - 可以使用系统定时任务（如cron）定期执行监控脚本
   - 示例监控脚本：
     ```python
     # monitor_schedule.py
     from src.model_monitor import ModelMonitor
     from src.config import DATA_PATHS
     import datetime
     
     def main():
         monitor = ModelMonitor()
         model_path = DATA_PATHS['models'] / 'lda_model.pkl'
         
         if model_path.exists():
             report = monitor.monitor_model_performance(model_path)
             
             # 保存报告
             report_file = DATA_PATHS['models'] / 'monitoring' / f'performance_report_{datetime.datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
             report_file.parent.mkdir(exist_ok=True)
             
             with open(report_file, 'w', encoding='utf-8') as f:
                 json.dump(report, f, ensure_ascii=False, indent=2)
             
             # 生成警报
             alert = monitor.generate_alert(report)
             if alert:
                 print(alert)
                 # 可以添加邮件通知等功能
     
     if __name__ == "__main__":
         main()
     ```

### 2.3 自动主题名称优化

**功能说明**：自动优化主题名称，提高主题可读性。

**操作步骤**：

1. **批量优化主题名称**：
   ```python
   from src.topic_name_optimizer import TopicNameOptimizer
   from src.topic_modeler import TopicModeler
   
   # 加载模型
   modeler = TopicModeler()
   modeler.load_model()
   
   # 获取主题
   topics = modeler.get_topics()
   
   # 优化主题名称
   optimizer = TopicNameOptimizer()
   optimized_topics = optimizer.optimize_all_topics(topics)
   
   # 查看优化结果
   for topic_name, keywords in optimized_topics.items():
       print(f"{topic_name}: {keywords}")
   ```

2. **单主题优化**：
   ```python
   # 优化单个主题名称
   topic_idx = 0
   keywords = topics[topic_idx]
   current_name = f"主题{topic_idx}"
   
   optimized_name = optimizer.optimize_topic_name(current_name, keywords)
   print(f"优化前: {current_name}")
   print(f"优化后: {optimized_name}")
   ```

## 3. 人工干预步骤

### 3.1 手动模型训练

**适用场景**：需要自定义训练参数或使用特定数据集时。

**操作步骤**：

1. **准备数据**：
   - 确保训练数据格式正确（Excel文件，包含评论和正文列）
   - 放置在`data/raw/`目录

2. **配置训练参数**：
   - 编辑`src/config.py`中的LDA配置：
     ```python
     LDA = {
         'n_components': 8,          # 主题数量
         'random_state': 42,
         'max_iter': 300,
         'learning_method': 'online',
         'learning_offset': 10.0,
         'doc_topic_prior': 0.3,
         'topic_word_prior': 0.001
     }
     ```

3. **执行手动训练**：
   ```python
   from src.topic_modeler import TopicModeler
   from src.data_processor import DataProcessor
   
   # 准备数据
   processor = DataProcessor()
   data = processor.process_data()
   
   # 训练模型
   modeler = TopicModeler()
   modeler.train_model(data)
   
   # 保存模型
   modeler.save_model()
   
   # 评估模型
   perplexity = modeler.evaluate_perplexity()
   coherence = modeler.evaluate_coherence()
   print(f"困惑度: {perplexity:.2f}")
   print(f"一致性: {coherence:.3f}")
   ```

### 3.2 手动主题名称调整

**适用场景**：自动优化的主题名称需要进一步调整时。

**操作步骤**：

1. **查看自动优化结果**：
   ```python
   from src.topic_name_optimizer import TopicNameOptimizer
   from src.topic_modeler import TopicModeler
   
   modeler = TopicModeler()
   modeler.load_model()
   topics = modeler.get_topics()
   
   optimizer = TopicNameOptimizer()
   optimized_topics = optimizer.optimize_all_topics(topics)
   
   for topic_name, keywords in optimized_topics.items():
       print(f"{topic_name}: {keywords}")
   ```

2. **手动调整主题名称**：
   - 创建调整后的主题名称映射：
     ```python
     # 手动调整主题名称
     manual_adjustments = {
         '社交互动': '社交互动与交流',
         '脱单恋爱': '恋爱与脱单',
         # 其他需要调整的主题
     }
     
     # 应用调整
     final_topics = {}
     for topic_name, keywords in optimized_topics.items():
         if topic_name in manual_adjustments:
             final_topics[manual_adjustments[topic_name]] = keywords
         else:
             final_topics[topic_name] = keywords
     ```

3. **保存调整后的主题**：
   ```python
   import json
   from src.config import DATA_PATHS
   
   with open(DATA_PATHS['models'] / 'optimized_topics.json', 'w', encoding='utf-8') as f:
       json.dump(final_topics, f, ensure_ascii=False, indent=2)
   ```

### 3.3 手动部署决策

**适用场景**：需要根据业务需求手动决定是否部署新模型时。

**操作步骤**：

1. **比较模型性能**：
   ```python
   from src.model_monitor import ModelMonitor
   from src.config import DATA_PATHS
   
   monitor = ModelMonitor()
   
   # 比较现有模型和新模型
   current_model = DATA_PATHS['models'] / 'lda_model.pkl'
   new_model = 'path/to/new/model.pkl'  # 新模型路径
   
   comparison = monitor.compare_models(current_model, new_model)
   print(f"更好的模型: {comparison['better_model']}")
   
   # 查看详细性能
   print("现有模型性能:")
   print(comparison['performance_metrics']['model1'])
   print("\n新模型性能:")
   print(comparison['performance_metrics']['model2'])
   ```

2. **手动执行部署**：
   - 如果决定部署新模型：
     ```python
     import shutil
     from src.config import DATA_PATHS
     
     # 备份现有模型
     backup_path = DATA_PATHS['models'] / f'backup_lda_model_{datetime.now().strftime("%Y%m%d_%H%M%S")}.pkl'
     shutil.copy2(DATA_PATHS['models'] / 'lda_model.pkl', backup_path)
     
     # 部署新模型
     shutil.copy2(new_model, DATA_PATHS['models'] / 'lda_model.pkl')
     print("模型部署完成")
     ```

### 3.4 模型回滚

**适用场景**：新部署的模型出现问题，需要回滚到之前的版本时。

**操作步骤**：

1. **执行回滚**：
   ```python
   from deploy_model import ModelDeployer
   
   deployer = ModelDeployer()
   
   # 回滚到上一次部署
   rollback_result = deployer.rollback_deployment()
   
   # 或回滚到指定部署
   # rollback_result = deployer.rollback_deployment(deployment_id='deploy_20240101_000000')
   
   print(f"回滚结果: {'成功' if rollback_result['success'] else '失败'}")
   if not rollback_result['success']:
       print(f"失败原因: {rollback_result['reason']}")
   ```

2. **验证回滚结果**：
   ```python
   from src.topic_modeler import TopicModeler
   
   modeler = TopicModeler()
   modeler.load_model()
   
   # 验证模型是否正常
   topics = modeler.get_topics()
   print(f"模型加载成功，共{len(topics)}个主题")
   ```

## 4. 常见问题处理流程

### 4.1 模型性能问题

| 问题 | 可能原因 | 处理方法 |
|------|---------|---------|
| 困惑度高 | 主题数量不合适 | 调整`n_components`参数，尝试不同的值 |
| 一致性低 | 主题数量过多或文本质量差 | 减少主题数量或提高文本预处理质量 |
| 主题不清晰 | 关键词质量差 | 优化数据预处理，增加自定义词典 |
| 性能退化 | 数据分布变化 | 重新训练模型，使用最新数据 |

### 4.2 部署问题

| 问题 | 可能原因 | 处理方法 |
|------|---------|---------|
| 部署失败 | 模型文件损坏 | 检查模型文件，重新训练 |
| 回滚失败 | 目标部署不存在 | 检查部署历史，选择正确的部署ID |
| 性能比较错误 | 模型格式不一致 | 确保两个模型使用相同的格式和版本 |

### 4.3 主题名称问题

| 问题 | 可能原因 | 处理方法 |
|------|---------|---------|
| 主题名称重复 | 核心概念相似 | 手动调整主题名称，增加区分度 |
| 主题名称模糊 | 关键词质量差 | 优化数据预处理，提高关键词质量 |
| 主题名称过长 | 自动优化参数设置 | 调整`topic_name_optimizer.py`中的长度评分标准 |

## 5. 最佳实践

### 5.1 数据处理最佳实践

1. **数据质量**：
   - 确保训练数据质量，去除噪声和无关内容
   - 定期更新训练数据，以反映最新的用户反馈

2. **预处理设置**：
   - 根据实际数据调整停用词列表
   - 维护自定义词典，提高分词质量

### 5.2 模型训练最佳实践

1. **参数调优**：
   - 尝试不同的主题数量（通常在5-15之间）
   - 调整`doc_topic_prior`和`topic_word_prior`参数以获得更好的主题质量

2. **训练频率**：
   - 定期（如每月）重新训练模型，以适应数据变化
   - 当业务需求发生变化时，及时更新模型

### 5.3 部署和监控最佳实践

1. **部署策略**：
   - 采用A/B测试，比较新旧模型性能
   - 确保部署过程中有备份，以便快速回滚

2. **监控策略**：
   - 定期（如每周）执行性能监控
   - 设置性能警报阈值，及时发现退化情况

3. **文档管理**：
   - 记录每次部署的配置和结果
   - 维护模型性能历史，分析长期趋势

### 5.4 人工干预最佳实践

1. **干预时机**：
   - 自动流程出现异常时
   - 业务需求有特殊要求时
   - 模型性能出现明显退化时

2. **干预方法**：
   - 基于数据和性能指标做出决策
   - 记录干预原因和结果，为未来优化提供参考
   - 保持干预的一致性，避免随机调整

## 6. 系统维护

### 6.1 定期维护任务

1. **数据维护**：
   - 清理过期数据
   - 更新停用词和自定义词典

2. **模型维护**：
   - 清理旧的模型版本
   - 整理部署历史和监控数据

3. **系统维护**：
   - 更新依赖库
   - 优化代码性能

### 6.2 故障排查

1. **日志分析**：
   - 查看`logs`目录中的日志文件
   - 分析部署和监控报告

2. **常见故障**：
   - **模型加载失败**：检查模型文件是否损坏
   - **数据处理错误**：检查数据格式和路径
   - **性能监控异常**：检查监控脚本和参数设置

## 7. 总结

本操作指南提供了主题模型系统的自动处理和人工干预的详细步骤，帮助您高效地使用和维护系统。通过合理使用自动功能和必要的人工干预，可以确保模型性能和业务需求的平衡，实现最佳的主题分析效果。

系统设计考虑了自动化和灵活性的平衡，既提供了全流程自动化的便利，又保留了必要的人工干预点，以适应不同场景的需求。随着使用经验的积累，您可以根据具体业务需求进一步优化处理流程，获得更好的主题模型效果。
