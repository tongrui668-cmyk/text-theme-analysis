<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主题分类工具</title>
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>🔍 主题分类工具</h1>

        <!-- 显示消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="{{ category }}-message">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 特性介绍 -->
        <div class="features">
            <h2>✨ 工具特性</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <h4>📊 智能分析</h4>
                    <p>使用先进的NLP技术，自动识别文本中的核心主题和关键词，提供精准的分析结果。</p>
                </div>
                <div class="feature-card">
                    <h4>🔄 多种格式支持</h4>
                    <p>支持文本文件、Excel表格和CSV文件，自动识别文本列，无需手动处理。</p>
                </div>
                <div class="feature-card">
                    <h4>⚡ 快速处理</h4>
                    <p>优化的算法设计，即使处理大量数据也能保持高效，让您快速获得分析结果。</p>
                </div>
            </div>
        </div>

        <!-- 文件格式说明 -->
        <div class="file-info">
            <h3>📁 支持的文件格式</h3>
            <ul>
                <li><strong>文本文件 (.txt)</strong>：纯文本格式，包含需要分析的评论内容</li>
                <li><strong>Excel文件 (.xlsx, .xls)</strong>：包含评论数据的表格，系统会自动识别文本列</li>
                <li><strong>CSV文件 (.csv)</strong>：逗号分隔值文件，系统会自动识别文本列</li>
            </ul>
            <p><strong>注意：</strong>文件大小建议不超过10MB，文本内容建议使用UTF-8编码</p>
        </div>

        <!-- 文件上传表单 -->
        <div class="upload-section">
            <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
                <label for="file">选择要分析的文件：</label>
                <div class="file-input-container">
                    <input type="file" name="file" id="file" required 
                           accept=".txt,.xlsx,.xls,.csv">
                    <div class="file-input-placeholder">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击或拖拽文件到此处</p>
                        <p>支持 .txt, .xlsx, .xls, .csv 格式</p>
                    </div>
                </div>
                <button type="submit" id="analyzeBtn">🚀 开始分析</button>
            </form>
        </div>

        <!-- 加载状态和进度条 -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <h3>分析中，请稍候...</h3>
                <div class="loading-spinner"></div>
                <div class="progress-text" id="progressText">准备开始分析...</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <p id="statusMessage">正在处理文件，请耐心等待...</p>
            </div>
        </div>

        <script>
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const fileInput = document.getElementById('file');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingOverlay = document.getElementById('loadingOverlay');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const statusMessage = document.getElementById('statusMessage');
                
                // 禁用按钮和文件输入
                analyzeBtn.disabled = true;
                fileInput.disabled = true;
                
                // 显示加载覆盖层
                loadingOverlay.style.display = 'flex';
                
                // 初始化进度条
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressText.textContent = '准备开始分析...';
                statusMessage.textContent = '正在处理文件，请耐心等待...';
                
                // 模拟初始进度
                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 10) {
                        progress += 1;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        progressText.textContent = `正在准备分析...`;
                    }
                }, 200);
                
                // 发送文件上传请求
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    clearInterval(interval);
                    
                    // 检查响应是否成功
                    if (response.ok) {
                        // 模拟分析进度
                        let analysisProgress = 10;
                        const analysisInterval = setInterval(() => {
                            if (analysisProgress < 95) {
                                analysisProgress += Math.floor(Math.random() * 5) + 1;
                                if (analysisProgress > 95) analysisProgress = 95;
                                progressBar.style.width = `${analysisProgress}%`;
                                progressBar.textContent = `${analysisProgress}%`;
                                progressText.textContent = `分析中...`;
                                statusMessage.textContent = `正在分析文本数据，请稍候...`;
                            }
                        }, 300);
                        
                        // 获取响应内容
                        return response.text().then(html => {
                            clearInterval(analysisInterval);
                            
                            // 更新进度为100%
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            progressText.textContent = '分析完成！';
                            statusMessage.textContent = '正在跳转到结果页面...';
                            
                            // 延迟跳转，让用户看到完成状态
                            setTimeout(() => {
                                // 替换当前页面内容
                                document.open();
                                document.write(html);
                                document.close();
                            }, 500);
                        });
                    } else {
                        // 处理错误
                        return response.text().then(errorHtml => {
                            loadingOverlay.style.display = 'none';
                            analyzeBtn.disabled = false;
                            fileInput.disabled = false;
                            
                            // 显示错误信息
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(errorHtml, 'text/html');
                            const errorMessage = doc.querySelector('.error-message');
                            
                            if (errorMessage) {
                                alert('分析失败：' + errorMessage.textContent);
                            } else {
                                alert('分析失败，请稍后重试');
                            }
                        });
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    loadingOverlay.style.display = 'none';
                    analyzeBtn.disabled = false;
                    fileInput.disabled = false;
                    alert('分析失败：' + error.message);
                });
            });
        </script>
    </div>
</body>
</html>